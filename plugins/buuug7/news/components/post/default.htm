{% set post = __SELF__.post %}

<div class="news-post-detail bg-white m-b">
    <div class="post-image">
        {% if post.image %}
        <div class="big-image">
            <img src="{{ post.image|media }}" alt="{{ post.title }}" class="img-responsive">
        </div>
        {% endif %}
    </div>

    <div class="post-info">
        <ul>
            <li>By {{ post.user.first_name }}</li>
            {% if post.categories.count %}
            <li>
                {% for category in post.categories %}
                <a href="{{ category.url}}">{{ category.name }}</a> {% if not loop.last %},{% endif %}
                {% endfor%}
            </li>
            {% endif %}
            <li>{{ post.publish_at|date('Y, m月 d') }}</li>
        </ul>
    </div>

    <div class="post-title">
        <h3>{{ post.title }}</h3>
    </div>

    <div class="post-content">
        {{ post.content|raw }}
    </div>
    <hr>

    {% if post.images %}
    <div class="post-images">
        <h4>图片集</h4>
        <div class="row">
            {% for item in post.images %}
            <div class="col-sm-6 col-md-3">
                <a href="{{ item.img_path|media }}">
                    <img src="{{ item.img_path|media }}" alt="{{ item.img_name }}" class="img-responsive" style="width: 100%">
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if post.files %}
    <div class="post-files">
        <h4>附件</h4>
        {% for item in post.files %}
        <a href="{{ item.file_path|media }}">{{ item.file_name }}</a>
        {% if not loop.last %} | {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="headline">
    <h2>评论</h2>
</div>

<!--post new comment-->
<div class="post-new-comment m-b clearfix">
    {% if user %}
    <a href="#modal-id-post-new-comment" class="btn btn-line-warning" data-toggle="modal">
        <i class="fa fa-plus"></i> 发表评论
    </a>
    {% else %}
    <p><a href="/user/login">登陆</a> 之后可发布评论</p>
    {% endif %}
    <div class="modal fade" id="modal-id-post-new-comment">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">发表新评论</h4>
                </div>
                <div class="modal-body">
                    <form
                            class="form-horizontal"
                            id="comment-form"
                    >
                        <textarea class="form-control" rows="3" name="content"></textarea>
                    </form>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-warning" id="comments-button">评论</a>
                    <a class="btn btn-line-warning" data-dismiss="modal">关闭</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% put scripts %}
<script>
    $(document).on('ajaxSetup', function (event, context) {
        // Enable AJAX handling of Flash messages on all AJAX requests
        context.options.flash = true;

        // Enable the StripeLoadIndicator on all AJAX requests
        context.options.loading = $.oc.stripeLoadIndicator;

        // Handle Error Messages by triggering a flashMsg of type error
        context.options.handleErrorMessage = function (message) {
            $.oc.flashMsg({text: message, class: 'error'});
        }

        // Handle Flash Messages by triggering a flashMsg of the message type
        context.options.handleFlashMessage = function (message, type) {
            $.oc.flashMsg({text: message, class: type});
        }
    })

    $(function () {
        $('#comments-button').on('click', function (e) {
            e.preventDefault();
            $('#comment-form').request('onPostNewComment', {
                data: {id: '{{ post.id }}'},
                success: function (data) {
                    this.success(data).done(function () {
                        $('#modal-id-post-new-comment').modal('hide');
                    });
                },
                update: {'news/comment': '.new-comment'}
            });
        })
    });
</script>
{% endput %}


<!--comment list-->
<ul class="list-group comments-v1">
    <div class="new-comment"></div>
    {% if post.comments.count %}
    {% partial 'news/comment' comments=post.comments %}
    {% endif %}
</ul>

